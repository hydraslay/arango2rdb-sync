<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Schema & Mapping Viewer</title>
    <link rel="stylesheet" th:href="@{/css/schema.css}">
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
</head>
<body>
<header class="page-header">
    <h1>Schema & Mapping Viewer</h1>
    <form class="filter-form" hx-trigger="submit"
          th:attr="hx-get=${activeRepositoryId} != null ? '/?repo=' + activeRepositoryId : '/', hx-target='#layout'">
        <label for="filter">Filter</label>
        <input id="filter" name="filter" type="text" th:value="${filter}">
        <input type="hidden" name="repo" th:if="${activeRepositoryId != null}" th:value="${activeRepositoryId}">
        <button type="submit">Apply</button>
        <button type="button"
                th:attr="hx-get=${activeRepositoryId} != null ? '/?repo=' + activeRepositoryId : '/', hx-target='#layout'">Reset</button>
    </form>
    <div class="repo-controls">
        <span th:if="${activeRepository != null}" th:text="'Repository: ' + ${activeRepository.name()}"></span>
        <span th:if="${activeRepository == null}">Repository: default</span>
        <form th:action="@{/sync}" method="post" class="repo-sync-form">
            <input type="hidden" name="repo" th:if="${activeRepositoryId != null}" th:value="${activeRepositoryId}">
            <button type="submit">Sync</button>
        </form>
        <a th:href="@{/repositories}">Manage Repositories</a>
    </div>
</header>

<main id="layout" class="layout">
    <section class="panel panel-left">
        <h2>ArangoDB Collections</h2>
        <div class="stack">
            <div th:if="${arangoCollections.isEmpty()}" class="empty">No collections found.</div>
            <div th:unless="${arangoCollections.isEmpty()}">
                <div th:each="collection : ${arangoCollections}">
                    <div th:replace="~{fragments/arango-collection :: collectionFragment(col=${collection})}"></div>
                </div>
            </div>
        </div>
    </section>

    <section class="panel panel-center">
        <h2>Merges</h2>
        <div class="stack mappings">
            <article class="mapping-card" th:if="${merges.isEmpty()}">
                <div class="empty">No merges defined in mapping.json.</div>
            </article>
            <div th:each="merge : ${merges}">
                <div th:replace="~{fragments/merge :: merge(merge=${merge})}"></div>
            </div>
        </div>
    </section>

    <section class="panel panel-right">
        <h2>Relational Tables</h2>
        <div class="stack">
            <div th:if="${rdbTables.isEmpty()}" class="empty">No tables found.</div>
            <div th:each="table : ${rdbTables}">
                <div th:replace="~{fragments/rdb-table :: table(table=${table}, repoId=${activeRepositoryId})}"></div>
            </div>
        </div>
    </section>
</main>

<script>
    (function () {
        function initialiseCard(button) {
            if (!(button instanceof HTMLElement)) {
                return;
            }
            const card = button.closest(".collapsible-card");
            if (!card) {
                return;
            }
            const collapsed = card.classList.contains("is-collapsed");
            button.setAttribute("aria-expanded", collapsed ? "false" : "true");
        }

        function hydrateCards(scope) {
            if (!(scope instanceof HTMLElement)) {
                scope = document.body;
            }
            scope.querySelectorAll("[data-card-toggle]").forEach(initialiseCard);
        }

        document.addEventListener("click", function (event) {
            const trigger = event.target.closest("[data-card-toggle]");
            if (!trigger) {
                return;
            }
            event.preventDefault();
            const card = trigger.closest(".collapsible-card");
            if (!card) {
                return;
            }
            const nextState = card.classList.toggle("is-collapsed");
            trigger.setAttribute("aria-expanded", nextState ? "false" : "true");
        });

        hydrateCards(document.body);

        document.body.addEventListener("htmx:afterSwap", function (event) {
            hydrateCards(event.target);
        });
    })();
</script>

</body>
</html>
